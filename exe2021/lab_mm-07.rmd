---
title: Математическое моделирование. Практика 7
date: "28 апреля, 2021"
author: "Самышко Полина"
output:
  html_document:
    always_allow_html: yes 
    df_print: default
    fig_caption: yes
    fig_height: 4.5
    fig_width: 9.5
    highlight: pygments
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
  word_document:
    df_print: default
    fig_caption: yes
    fig_height: 4.5
    fig_width: 9.5
    highlight: pygments
    toc: true
  pdf_document:
    html_notebook:
    code_folding: hide
    df_print: paged
    highlight: tango
    theme: cosmo
    toc: yes
---

# Задание:

Необходимо построить две модели:\
\* зависимости непрерывного отклика от одного непрерывного предиктора;\
\* зависимости вероятности (логит) от одного непрерывного предиктора.

Для каждой модели:

1.  Указать смысл переменных модели, метод оценки и настроечный параметр (степень полинома, гиперпараметр $λ$, ширина окна $s$, число узлов -- в зависимости от метода).

2.  Подогнать модель на всех наблюдениях, меняя значение настроечного параметра.

3.  Обосновать оптимальное значение настроечного параметра подходящим методом (кросс-валидация, $ANOVA$).

4.  Сделать прогноз на обучающую выборку по лучшей модели: модельные значения и ошибки прогноза.

5.  Построить график с фактическими наблюдениями, модельной кривой и 95% доверительными интервалами прогноза.

В таблице ниже указаны набор данных, столбцы с переменными для модели и метод подгонки.

**Вариант 5**

+--------------------+-----------------+--------------------------+----------------------------+-----------------------------------+-------------------------------+
| **Номер варианта** | **Данные**      | **Зависимая переменная** | **Объясняющая переменная** | **Вероятность для второй модели** | **Метод подгонки моделей**    |
+====================+=================+==========================+============================+===================================+===============================+
| 5                  | `Boston {MASS}` | `nox`                    | `dis`                      | $P(nox>0.8)$                      | Натуральный кубический сплайн |
+--------------------+-----------------+--------------------------+----------------------------+-----------------------------------+-------------------------------+

**Как сдавать**: прислать на почту преподавателя ссылки:

\* на html-отчёт с видимыми блоками кода (блоки кода с параметром echo = T), размещённый на [rpubs.com](rpubs.com "rpubs.com").

\* на код, генерирующий отчёт, в репозитории на [github.com](github.com "github.com"). В текст отчёта включить постановку задачи и ответы на вопросы задания.

# Решение

Исходные данные --- таблица `Boston` с данными по стоимости жилья в пригороде Бостона\
Зависимая переменная `nox` (концентрация оксидов азота (частей на 10 млн).)\
Объясняющая переменная `dis` (средневзвешенное расстояние до пяти центров занятости г. Бостона).\
Вероятность для второй модели $P(nox>0.8)$\
Подключаем набор данных `Boston`\

```{r echo=T}
library('splines', quietly = T)           # сплайны
library('gam', quietly = T, verbose = F)               # обобщённые аддитивные модели
library(MASS)
attach(Boston)
data(Boston)
head(Boston)
str(Boston)
# ?Boston # описание набора данных
```

Построим кубический сплайн с тремя узлами.

```{r}
# границы изменения переменной dis
dis_lims <- range(dis)

# значения age, для которых делаем прогноз (от min до max с шагом 1)
dis_grid <- seq(from = dis_lims[1], to = dis_lims[2])

# кубический сплайн с тремя узлами
fit <- lm(nox ~ bs(dis, knots = c(25, 40, 60)), data = Boston)
# прогноз
preds_spl <- predict(fit, newdata = list(dis = dis_grid), se = T)

```

Теперь построим натуральный по трём узлам. Три узла это 6 степеней свободы. Если функции `bs()`, которая создаёт матрицу с базисом для полиномиального сплайна, передать только степени свободы, она распределит узлы равномерно. В данном случае это квартили распределения `dis`.

```{r echo=TRUE}
# 3 узла -- 6 степеней свободы (столбцы матрицы)
dim(bs(dis, knots = c(25, 40, 60)))

# если не указываем узлы явно...
dim(bs(dis, df = 6))
#  они привязываются к квартилям
attr(bs(dis, df = 6), 'knots')
# натуральный сплайн
fit2 <- lm(nox ~ ns(dis, df = 4), data = Boston)
preds_spl2 <- predict(fit2, newdata = list(dis = dis_grid), se = T)

```

График сравнения кубического и натурального сплайнов.

```{r echo=TRUE}
par(mfrow = c(1, 1), mar = c(4.5, 4.5, 1, 8.5), oma = c(0, 0, 0, 0), xpd = T)

# наблюдения
plot(dis, nox, col = 'grey')

# модель кубического сплайна
lines(dis_grid, preds_spl$fit, lwd = 2)

# доверительный интервал
lines(dis_grid, preds_spl$fit + 2*preds_spl$se, lty = 'dashed')
lines(dis_grid, preds_spl$fit - 2*preds_spl$se, lty = 'dashed')

# натуральный сплайн
lines(dis_grid, preds_spl2$fit, col = 'red', lwd = 2)

# легенда
legend("topright", inset = c(-0.7, 0),
       c('Кубический \n с 3 узлами', 'Натуральный'),
       lwd = rep(2, 2), col = c('black', 'red'))

# заголовок
title("Сплайны")

```

Построим график со слайда 20 (рисунок 7.8 книги).

```{r echo=TRUE}
par(mfrow = c(1, 1), mar = c(4.5, 4.5, 1, 1), oma = c(0, 0, 4, 0))

# наблюдения
plot(dis, nox, xlim = dis_lims, cex = 0.5, col = 'darkgrey')

# заголовок
title('Сглаживающий сплайн')

# подгоняем модель с 16 степенями свободы
fit <- smooth.spline(dis, nox, df = 16)

# подгоняем модель с подбором лямбды с помощью перекрёстной проверки
fit2 <- smooth.spline(dis, nox, cv = T)
fit2$df

# рисуем модель
lines(fit, col = 'red', lwd = 2)
lines(fit2, col = 'blue', lwd = 2)
legend('topright', 
       c('16 df', '6.8 df'),
       col = c('red', 'blue'), lty = 1, lwd = 2, cex = 0.8)

```

# Логистическая GAM

Построим логистическую GAM на натуральном кубическом сплайне `ns` для всероятности того, что `nox` превышает **0.8**

```{r}
# knots <- quantile(nox, p = c(0.25, 0.5, 0.75))
# knots <- quantile(dis, p = c(0.25, 0.5, 0.75))
gam_lr <- gam(I(nox > 0.8) ~ ns(dis, knots = c(2.1, 3.2, 5.1)), family = 'binomial', data = Boston)
plot.Gam(gam_lr, se = T, col = 'green')

```

*Источники*

1.  *Джеймс Г., Уиттон Д., Хасти Т., Тибширани Р.* Введение в статистическое обучение с примерами на языке R / пер. с англ. С.Э. Мастицкого. -- М.: ДМК Пресс, **2016** -- 450 с. Репозиторий с примерами к книге на русском языке: <https://github.com/ranalytics/islr-ru>
